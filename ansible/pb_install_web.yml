---
- name: Install nginx
  hosts: web
  become: true

  tasks:

    - name: Install depends 
      ansible.builtin.apt:
        name: 
          - curl
          - gnupg2
          - ca-certificates
        update_cache: yes

    - name: Add Docker GPG apt Key
      ansible.builtin.apt_key:
        url: https://nginx.org/keys/nginx_signing.key
        state: present

    - name: Add Docker Repository
      apt_repository:
        repo: "deb http://nginx.org/packages/ubuntu  jammy nginx"
        state: present

    - name: Install nginx
      ansible.builtin.apt:
        name: 
          - nginx
        update_cache: yes

    - name: Copy config nginx
      ansible.builtin.copy:
        src: "./files/nginx/{{ item }}"
        dest: /etc/nginx/
        mode: '0644'
      loop:
        - nginx.conf
        - nginx-selfsigned.crt
        - nginx-selfsigned.key
        - dhparam.pem
      notify:
        - Restart nginx

    - name: Create a directory for cache
      ansible.builtin.file:
        path: /var/nginx/cache
        state: directory
        mode: '0755'
        owner: www-data
        group: www-data
      notify:
        - Restart nginx

    - name: Copy exporter
      ansible.builtin.copy:
        src: "./files/nginx/{{ item.name }}"
        dest: "{{ item.dest }}"
        mode: "{{ item.mode | default('0644') }}"
      loop:
        - name: nginx-prometheus-exporter
          mode: "0744"
          dest: /usr/local/bin/
        - name: nginx_exporter.service
          dest: /etc/systemd/system/
      notify:
        - Restart exporter

    - name: Add the user nginx-exporter
      ansible.builtin.user:
        name: nginx-exporter
        create_home: false
        shell: /bin/false
        system: true

  handlers:
    - name: Restart exporter
      ansible.builtin.service:
        name: nginx_exporter
        state: restarted
        daemon_reload: true

    - name: Restart nginx
      ansible.builtin.service:
        name: nginx
        state: restarted

